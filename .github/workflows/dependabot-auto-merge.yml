# ğŸ¤– Dependabot Auto-Merge Workflow
# Automatically merges Dependabot PRs for patch and minor updates after CI passes

name: Auto-merge Dependabot PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  auto-merge:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      checks: read

    steps:
      - name: ğŸ” Check if PR is from Dependabot
        id: check-dependabot
        run: |
          if [[ "${{ github.actor }}" == "dependabot[bot]" ]]; then
            echo "is_dependabot=true" >> $GITHUB_OUTPUT
          else
            echo "is_dependabot=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“‹ Get PR metadata
        id: pr-metadata
        if: steps.check-dependabot.outputs.is_dependabot == 'true'
        uses: dependabot/fetch-metadata@v1
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: âœ… Auto-approve PR
        if: |
          steps.check-dependabot.outputs.is_dependabot == 'true' && 
          (steps.pr-metadata.outputs.update-type == 'version-update:semver-patch' || 
           steps.pr-metadata.outputs.update-type == 'version-update:semver-minor')
        run: |
          gh pr review --approve "${{ github.event.pull_request.html_url }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸš€ Auto-merge PR
        if: |
          steps.check-dependabot.outputs.is_dependabot == 'true' && 
          (steps.pr-metadata.outputs.update-type == 'version-update:semver-patch' || 
           steps.pr-metadata.outputs.update-type == 'version-update:semver-minor')
        run: |
          # Wait for CI to complete
          gh pr merge --auto --merge "${{ github.event.pull_request.html_url }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“ Add comment for major updates
        if: |
          steps.check-dependabot.outputs.is_dependabot == 'true' && 
          steps.pr-metadata.outputs.update-type == 'version-update:semver-major'
        run: |
          gh pr comment "${{ github.event.pull_request.html_url }}" --body "ğŸš¨ **Major version update detected!** 

          This PR contains a major version update that may include breaking changes. Please:
          
          1. ğŸ” Review the changelog for breaking changes
          2. ğŸ§ª Test the changes thoroughly  
          3. ğŸ“– Update documentation if needed
          4. âœ… Manually merge when ready
          
          Major updates require manual review for safety."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}